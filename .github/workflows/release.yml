name: Release (GBS Player)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Flutter version (.fvmrc)
        run: |
          FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)
          echo "FLUTTER_VERSION=${FLUTTER_VERSION}" >> "$GITHUB_ENV"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Optional Android signing setup
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/keystore.jks
          cat > android/app/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          EOF

      - name: Build Android (release if signed, else debug)
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            flutter build apk --release --flavor production --build-number=${{ github.run_number }}
            cp build/app/outputs/flutter-apk/app-production-release.apk gbs-player-android.apk
          else
            flutter build apk --debug --flavor production --build-number=${{ github.run_number }}
            cp build/app/outputs/flutter-apk/app-production-debug.apk gbs-player-android-debug.apk
          fi

      - name: Build Web (release)
        run: |
          flutter build web --release
          cd build/web
          zip -r ../../gbs-player-web.zip .

      - name: Generate checksums
        run: |
          sha256sum *.apk *.zip 2>/dev/null | tee SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.apk
            *.zip
            SHA256SUMS.txt
